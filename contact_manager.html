<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missionary Contact Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background-color: #f5f7fa; }
        .main-section { padding: 2rem 1.5rem; }
        .table-container { overflow-x: auto; min-height: 400px; padding-bottom: 100px; }
        .table th { white-space: nowrap; }
        .table td { vertical-align: middle; }
        .table th[data-key="phone"], .table td[data-key="phone"] { min-width: 240px; }
        .table td[data-key="verified"] { text-align: center; }
        
        /* Make Full Name column distinct */
        .table td[data-key="originalName"] { font-size: 0.9em; color: #555; white-space: nowrap; }

        .is-placeholder { background: #f0f0f0; border: 2px dashed #ccc; }
        .modal-card-body { max-height: 70vh; overflow-y: auto; }
        [contenteditable="true"]:focus { outline: 2px solid #3273dc; background-color: #fdfdbe; }
        .action-buttons button, .action-buttons .dropdown { margin-right: 5px; }
        
        /* Zone Header Styling */
        .zone-header th { 
            background-color: #485fc7 !important; 
            color: #fff !important;
            font-weight: bold; 
            padding: 0.75em 1em; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .icon { display: inline-flex; align-items: center; }
        #restore-backup-input { display: none; }
        
        /* Drag and Drop Styles for Column Menu */
        #column-toggle-container { max-height: 300px; overflow-y: auto; }
        .dropdown-item.sortable-item { cursor: grab; display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f5f5f5; }
        .dropdown-item.sortable-item:active { cursor: grabbing; background-color: #f0f0f0; }
        .drag-handle { margin-right: 10px; color: #b5b5b5; }

        /* Toast Notification Styles */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 24px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <section class="section main-section">
        <div class="container">
            <div class="level">
                <div class="level-left">
                    <div>
                        <h1 class="title" data-lang-key="title">Missionary Contact Manager</h1>
                        <p class="subtitle" data-lang-key="subtitle">Upload, manage, and export missionary contacts.</p>
                    </div>
                </div>
                <div class="level-right">
                    <div class="field">
                        <label class="label" data-lang-key="languageLabel">Language</label>
                        <div class="control">
                            <div class="select">
                                <select id="language-selector">
                                    <option value="en">English</option>
                                    <option value="pt">Português</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <div class="field">
                        <label class="label" data-lang-key="uploadHeader">1. Start with a New Roster</label>
                        <div class="control">
                             <input class="input is-primary" type="file" id="file-upload" accept=".xlsx, .xls, .csv">
                        </div>
                        <p class="help" data-lang-key="uploadHelp">Select the Excel or CSV file containing the missionary roster.</p>
                    </div>
                    <div class="is-divider" data-content="OR"></div>
                     <div class="field">
                        <label class="label" data-lang-key="restoreHeader">Restore From Backup</label>
                         <div class="control">
                             <label for="restore-backup-input" class="button is-warning is-fullwidth">
                                 <span class="icon"><i data-lucide="upload"></i></span>
                                 <span data-lang-key="restore">Restore a .json Backup File</span>
                             </label>
                             <input type="file" id="restore-backup-input" accept=".json">
                        </div>
                        <p class="help" data-lang-key="restoreHelp">Load a previously saved backup file to continue your work.</p>
                    </div>
                </div>
            </div>

            <div id="main-content" class="mt-5" style="display: none;">
                <div class="level">
                     <div class="level-left">
                        <div class="level-item">
                            <button id="add-missionary-btn" class="button is-success">
                                <span class="icon"><i data-lucide="user-plus"></i></span>
                                <span data-lang-key="addNew">Add New Row</span>
                            </button>
                        </div>
                        <div class="level-item">
                            <button id="clear-all-btn" class="button is-danger is-light">
                                <span class="icon"><i data-lucide="trash-2"></i></span>
                                <span data-lang-key="clearAll">Clear All Contacts</span>
                            </button>
                        </div>
                    </div>
                     <div class="level-right">
                        <div class="level-item">
                            <div class="dropdown is-hoverable is-right">
                                <div class="dropdown-trigger">
                                    <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
                                        <span class="icon"><i data-lucide="settings"></i></span>
                                        <span data-lang-key="columns">Columns</span>
                                        <span class="icon is-small"><i data-lucide="chevron-down"></i></span>
                                    </button>
                                </div>
                                <div class="dropdown-menu" id="column-toggle-menu" role="menu">
                                    <div class="dropdown-content" id="column-toggle-container">
                                        </div>
                                </div>
                            </div>
                        </div>
                         <div class="level-item">
                             <div class="buttons has-addons">
                                <button id="export-csv-btn" class="button is-info">
                                    <span class="icon"><i data-lucide="file-spreadsheet"></i></span>
                                    <span data-lang-key="exportCsv">Export CSV</span>
                                </button>
                                 <button id="export-changed-btn" class="button is-primary">
                                    <span class="icon"><i data-lucide="file-diff"></i></span>
                                    <span data-lang-key="exportChanged">Export Changed</span>
                                </button>
                                <button id="export-vcard-btn" class="button is-link">
                                    <span class="icon"><i data-lucide="contact"></i></span>
                                    <span data-lang-key="exportVcard">Export vCard</span>
                                </button>
                                <button id="backup-btn" class="button is-dark">
                                    <span class="icon"><i data-lucide="save"></i></span>
                                    <span data-lang-key="backup">Backup (JSON)</span>
                                </button>
                             </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table is-bordered is-striped is-hoverable is-fullwidth">
                        <thead id="table-head">
                            </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <div id="mapping-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" data-lang-key="mapColumnsTitle">2. Map Your Columns</p>
            </header>
            <section class="modal-card-body">
                <p class="mb-4" data-lang-key="mapColumnsHelp">Please match the columns from your file to the required fields. Important: AREA is used to group companionships.</p>
                <form id="mapping-form">
                    </form>
            </section>
            <footer class="modal-card-foot">
                <button id="process-data-btn" class="button is-success" data-lang-key="processData">Process Data</button>
                <button id="cancel-mapping-btn" class="button" data-lang-key="cancel">Cancel</button>
            </footer>
        </div>
    </div>
    
    <div id="missionary-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="missionary-modal-title">Edit Contact</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <form id="missionary-form">
                    <input type="hidden" id="missionary-id">
                    <div class="field">
                        <label class="label" data-lang-key="nameLabel">Contact Name (e.g. E. Smith)</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-name" required>
                        </div>
                    </div>
                    
                     <div class="field">
                        <label class="label" data-lang-key="areaLabel">Area</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-area" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" data-lang-key="districtLabel">District</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-district">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" data-lang-key="zoneLabel">Zone</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-zone" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" data-lang-key="phoneLabel">Phone Number</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-phone" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" data-lang-key="addressLabel">Address</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-address">
                        </div>
                    </div>
                     <div class="field">
                        <label class="label" data-lang-key="positionLabel">Position</label>
                        <div class="control">
                            <input class="input" type="text" id="modal-position">
                        </div>
                    </div>
                     <div class="field">
                        <label class="label" data-lang-key="typeLabel">Type</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="modal-type">
                                    <option value="Unknown" data-lang-key="select">-- Select --</option>
                                    <option value="Elder" data-lang-key="elder">Elder</option>
                                    <option value="Sister" data-lang-key="sister">Sister</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button id="save-missionary-btn" class="button is-success" data-lang-key="save">Save</button>
                <button class="button" id="cancel-missionary-modal-btn" data-lang-key="cancel">Cancel</button>
            </footer>
        </div>
    </div>

    <div id="clear-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" data-lang-key="confirmClearTitle">Clear All Contacts</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <p data-lang-key="confirmClearBody">Are you sure you want to delete all contacts? This action cannot be undone unless you have a backup.</p>
            </section>
            <footer class="modal-card-foot">
                <button id="confirm-clear-btn" class="button is-danger" data-lang-key="clearAll">Clear All</button>
                <button id="cancel-clear-btn" class="button" data-lang-key="cancel">Cancel</button>
            </footer>
        </div>
    </div>

    <div id="toast-container"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Translations and Language Setup ---
    const translations = {
        en: {
            title: 'Missionary Contact Manager',
            subtitle: 'Upload, manage, and export missionary contacts.',
            languageLabel: 'Language',
            uploadHeader: '1. Start with a New Roster',
            uploadHelp: 'Select the Excel or CSV file containing the missionary roster.',
            restoreHeader: 'Restore From Backup',
            restoreHelp: 'Load a previously saved backup file to continue your work.',
            addNew: 'Add New Row',
            clearAll: 'Clear All',
            confirmClearTitle: 'Clear All Contacts',
            confirmClearBody: 'Are you sure you want to delete all contacts? This action cannot be undone unless you have a backup.',
            columns: 'Columns',
            exportCsv: 'Export CSV',
            exportChanged: 'Export Changed',
            exportVcard: 'Export vCard',
            backup: 'Backup (JSON)',
            restore: 'Restore a .json Backup File',
            mapColumnsTitle: '2. Map Your Columns',
            mapColumnsHelp: 'Please match the columns. AREA is used to group companionships.',
            processData: 'Process Data',
            cancel: 'Cancel',
            addMissionaryTitle: 'Add New Row',
            editMissionaryTitle: 'Edit Contact',
            nameLabel: 'Contact Name',
            areaLabel: 'Area',
            districtLabel: 'District',
            zoneLabel: 'Zone',
            phoneLabel: 'Phone Number',
            addressLabel: 'Address',
            positionLabel: 'Position',
            typeLabel: 'Type',
            elder: 'Elder',
            sister: 'Sister',
            save: 'Save',
            other: 'Other...',
            select: '-- Select --',
            unassigned: 'Unassigned',
            confirmDelete: 'Are you sure you want to delete this row?',
            enterNewPhone: 'Enter the new phone number:',
            dataRestored: 'Data restored successfully!',
            invalidBackup: 'Invalid backup file format.',
            parseError: 'Could not parse the backup file.',
            noDataBackup: 'No data to back up.',
            noChangesFound: 'No changes found.',
            phoneUpdated: 'Phone Number Updated',
            contactUpdated: 'Contact Name Updated',
            colVerified: 'Verified',
            colName: 'Contact Name',
            colFullName: 'Full Name(s)',
            colArea: 'Area',
            colDistrict: 'District',
            colZone: 'Zone',
            colPhone: 'Phone',
            colAddress: 'Address',
            colPosition: 'Position',
            colType: 'Type',
            colActions: 'Actions',
            csvFirstName: 'First Name',
            csvMiddleName: 'Middle Name',
            csvLastName: 'Last Name',
            csvPhoneNumber: 'Phone Number'
        },
        pt: {
            title: 'Gerenciador de Contatos de Missionários',
            subtitle: 'Carregue, gerencie e exporte contatos de missionários.',
            languageLabel: 'Idioma',
            uploadHeader: '1. Comece com uma Nova Lista',
            uploadHelp: 'Selecione o arquivo Excel ou CSV.',
            restoreHeader: 'Restaurar de Backup',
            restoreHelp: 'Carregue um backup salvo.',
            addNew: 'Adicionar Nova Linha',
            clearAll: 'Limpar Tudo',
            confirmClearTitle: 'Limpar Todos os Contatos',
            confirmClearBody: 'Tem certeza de que deseja excluir todos os contatos? Esta ação não pode ser desfeita.',
            columns: 'Colunas',
            exportCsv: 'Exportar CSV',
            exportChanged: 'Exportar Alterados',
            exportVcard: 'Exportar vCard',
            backup: 'Backup (JSON)',
            restore: 'Restaurar Backup .json',
            mapColumnsTitle: '2. Mapeie Suas Colunas',
            mapColumnsHelp: 'Associe as colunas. ÁREA é usada para agrupar as duplas.',
            processData: 'Processar Dados',
            cancel: 'Cancelar',
            addMissionaryTitle: 'Adicionar Nova Linha',
            editMissionaryTitle: 'Editar Contato',
            nameLabel: 'Nome do Contato',
            areaLabel: 'Área',
            districtLabel: 'Distrito',
            zoneLabel: 'Zona',
            phoneLabel: 'Número de Telefone',
            addressLabel: 'Endereço',
            positionLabel: 'Posição',
            typeLabel: 'Tipo',
            elder: 'Elder',
            sister: 'Sister',
            save: 'Salvar',
            other: 'Outro...',
            select: '-- Selecione --',
            unassigned: 'Não atribuído',
            confirmDelete: 'Tem certeza de que deseja excluir esta linha?',
            enterNewPhone: 'Digite o novo número de telefone:',
            dataRestored: 'Dados restaurados com sucesso!',
            invalidBackup: 'Formato inválido.',
            parseError: 'Erro ao ler arquivo.',
            noDataBackup: 'Nenhum dado para fazer backup.',
            noChangesFound: 'Nenhuma alteração encontrada.',
            phoneUpdated: 'Telefone Atualizado',
            contactUpdated: 'Nome do Contato Atualizado',
            colVerified: 'Verificado',
            colName: 'Nome do Contato',
            colFullName: 'Nome Completo',
            colArea: 'Área',
            colDistrict: 'Distrito',
            colZone: 'Zona',
            colPhone: 'Telefone',
            colAddress: 'Endereço',
            colPosition: 'Posição',
            colType: 'Tipo',
            colActions: 'Ações',
            csvFirstName: 'Primeiro Nome',
            csvMiddleName: 'Nome do Meio',
            csvLastName: 'Sobrenome',
            csvPhoneNumber: 'Número de Telefone'
        }
    };

    const languageSelector = document.getElementById('language-selector');
    let currentLang = 'en';

    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        void toast.offsetWidth; 
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function setLanguage(lang) {
        if (missionaryData.length > 0 && lang !== currentLang) {
            missionaryData.forEach(m => {
                if (lang === 'pt') {
                    m.name = m.name.replace(/ & /g, ' e ');
                } else {
                    m.name = m.name.replace(/ e /g, ' & ');
                }
            });
            saveToLocalStorage();
        }

        currentLang = lang;
        localStorage.setItem('missionaryLang', lang);
        languageSelector.value = lang;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        
        if (missionaryData.length > 0) {
            render();
        }
    }

    languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

    // --- Core Application Logic ---
    const fileUpload = document.getElementById('file-upload');
    const mappingModal = document.getElementById('mapping-modal');
    const mappingForm = document.getElementById('mapping-form');
    const processDataBtn = document.getElementById('process-data-btn');
    const cancelMappingBtn = document.getElementById('cancel-mapping-btn');
    const mainContent = document.getElementById('main-content');
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    const columnToggleContainer = document.getElementById('column-toggle-container');
    const addMissionaryBtn = document.getElementById('add-missionary-btn');
    const missionaryModal = document.getElementById('missionary-modal');
    const saveMissionaryBtn = document.getElementById('save-missionary-btn');
    const cancelMissionaryModalBtn = document.getElementById('cancel-missionary-modal-btn');
    const missionaryModalCloseBtn = missionaryModal.querySelector('.delete');
    
    // Clear All Logic
    const clearAllBtn = document.getElementById('clear-all-btn');
    const clearModal = document.getElementById('clear-modal');
    const confirmClearBtn = document.getElementById('confirm-clear-btn');
    const cancelClearBtn = document.getElementById('cancel-clear-btn');
    const closeClearModalBtn = clearModal.querySelector('.delete');

    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportChangedBtn = document.getElementById('export-changed-btn');
    const exportVcardBtn = document.getElementById('export-vcard-btn');
    const backupBtn = document.getElementById('backup-btn');
    const restoreBackupInput = document.getElementById('restore-backup-input');

    let rawData = [];
    let headers = [];
    let missionaryData = [];
    let initialUploadData = [];
    
    const LEADERSHIP_POSITIONS = ["AP", "SA", "ZL1", "ZL2", "ZL", "STL1", "STL2", "STL", "STLT"];

    let columnConfig = [
        { key: 'type', titleKey: 'colType', visible: true, editable: false },
        { key: 'name', titleKey: 'colName', visible: true, editable: true }, 
        { key: 'originalName', titleKey: 'colFullName', visible: true, editable: false },
        { key: 'position', titleKey: 'colPosition', visible: true, editable: false },
        { key: 'zone', titleKey: 'colZone', visible: true, editable: true },
        { key: 'district', titleKey: 'colDistrict', visible: false, editable: true },
        { key: 'address', titleKey: 'colAddress', visible: false, editable: true },
        { key: 'area', titleKey: 'colArea', visible: true, editable: true },
        { key: 'phone', titleKey: 'colPhone', visible: true, editable: false },
        { key: 'verified', titleKey: 'colVerified', visible: true, editable: false },
        { key: 'actions', titleKey: 'colActions', visible: true, editable: false },
    ];

    const requiredFields = { name: "Name", zone: "Zone", district: "District", area: "Area", phone: "Phone Number", address: "Address", position: "Position", type: "Type" };

    function loadFromLocalStorage() {
        const savedLang = localStorage.getItem('missionaryLang') || 'en';
        setLanguage(savedLang);

        const savedData = localStorage.getItem('missionaryContactData');
        const savedColumns = localStorage.getItem('missionaryColumnConfig');
        const savedInitialData = localStorage.getItem('missionaryInitialData');

        if (savedData) {
            missionaryData = JSON.parse(savedData);
            if (savedColumns) columnConfig = JSON.parse(savedColumns);
            if (savedInitialData) initialUploadData = JSON.parse(savedInitialData);
            mainContent.style.display = 'block';
            render();
        }
    }

    function saveToLocalStorage() {
        localStorage.setItem('missionaryContactData', JSON.stringify(missionaryData));
        localStorage.setItem('missionaryColumnConfig', JSON.stringify(columnConfig));
        localStorage.setItem('missionaryInitialData', JSON.stringify(initialUploadData));
    }

    fileUpload.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            if (rawData.length < 1) return;
            headers = rawData[0].map(h => String(h));
            rawData.shift();
            setupMappingModal();
        };
        reader.readAsArrayBuffer(file);
    });

    function setupMappingModal() {
        mappingForm.innerHTML = '';
        const headerOptions = headers.map(h => `<option value="${h}">${h}</option>`).join('');
        for (const [key, label] of Object.entries(requiredFields)) {
            const field = document.createElement('div');
            field.className = 'field is-horizontal';
            const translatedLabel = translations[currentLang][`${key}Label`] || label;
            field.innerHTML = `<div class="field-label is-normal"><label class="label">${translatedLabel}</label></div><div class="field-body"><div class="field"><div class="control"><div class="select is-fullwidth"><select data-key="${key}"><option value="">-- ${translations[currentLang].select} --</option>${headerOptions}</select></div></div></div></div>`;
            mappingForm.appendChild(field);
            const select = field.querySelector('select');
            const matchingHeader = headers.find(h => h.toLowerCase().includes(label.toLowerCase().split(' ')[0]));
            if(matchingHeader) select.value = matchingHeader;
        }
        mappingModal.classList.add('is-active');
    }

    // --- MAIN PROCESSING LOGIC ---
    processDataBtn.addEventListener('click', () => {
        const mapping = {};
        mappingForm.querySelectorAll('select').forEach(sel => { mapping[sel.dataset.key] = sel.value; });
        
        const individualMissionaries = rawData.map((row, index) => {
            const data = {};
            for (const key in requiredFields) {
                const header = mapping[key];
                const colIndex = headers.indexOf(header);
                data[key] = colIndex !== -1 ? (row[colIndex] || '') : '';
            }
            return cleanIndividualData(data);
        });

        const groupedByArea = {};
        individualMissionaries.forEach(m => {
            const areaKey = m.area.toUpperCase().trim();
            if (!groupedByArea[areaKey]) groupedByArea[areaKey] = [];
            groupedByArea[areaKey].push(m);
        });

        const finalRows = [];
        let idCounter = Date.now();

        Object.keys(groupedByArea).forEach(area => {
            const group = groupedByArea[area];
            
            const isSeniorCouple = group.some(m => m.type === 'Senior Couple');

            if (isSeniorCouple) {
                group.forEach(m => {
                    m.type = 'Unknown'; 
                    finalRows.push(createContactRow(m, null, idCounter++));
                });
                return;
            }

            const knownType = group.find(m => m.type !== 'Unknown')?.type;
            if (knownType) {
                group.forEach(m => { if(m.type === 'Unknown') m.type = knownType; });
            }

            const types = new Set(group.map(m => m.type));
            const isMixedTypes = types.has('Elder') && types.has('Sister');
            const hasLeadership = group.some(m => LEADERSHIP_POSITIONS.includes(m.position));

            if (hasLeadership || isMixedTypes || group.length === 1) {
                group.forEach(m => {
                    finalRows.push(createContactRow(m, null, idCounter++));
                });
            } else {
                finalRows.push(createCombinedContactRow(group, idCounter++));
            }
        });

        missionaryData = finalRows;
        initialUploadData = JSON.parse(JSON.stringify(finalRows));
        
        saveToLocalStorage();
        render();
        mainContent.style.display = 'block';
        mappingModal.classList.remove('is-active');
    });

    cancelMappingBtn.addEventListener('click', () => {
        mappingModal.classList.remove('is-active');
        fileUpload.value = '';
    });

    function cleanIndividualData(data) {
        const [lastName, firstName] = (String(data.name) || ',').split(',').map(s => s.trim());
        data.firstName = firstName || ''; 
        data.lastName = lastName || '';
        data.originalName = String(data.name) || '';
        data.zone = (String(data.zone) || '').replace(/ZONA/gi, '').trim();
        
        const positionMatch = (String(data.position) || '').match(/\((.*?)\)/);
        data.position = positionMatch ? positionMatch[1].trim().toUpperCase() : (String(data.position) || '').toUpperCase();
        
        const phoneStr = String(data.phone || '').trim();
        const cleanedNumbers = (phoneStr.match(/\+?[0-9\s]+/g) || []).map(n => n.replace(/\D/g, '')).filter(n => n.length > 5).map(n => '+258' + n.slice(-9));
        data.phoneNumbers = [...new Set(cleanedNumbers)];
        data.selectedPhone = data.phoneNumbers[0] || '';

        const typeStr = String(data.type || '').toLowerCase();
        if (typeStr.includes('couple') || typeStr.includes('casal') || typeStr.includes('senior')) data.type = 'Senior Couple';
        else if (typeStr.includes('sister') || typeStr.includes('síster')) data.type = 'Sister';
        else if (typeStr.includes('elder') || typeStr.includes('élder')) data.type = 'Elder';
        else data.type = 'Unknown';

        return data;
    }

    function createContactRow(m, partner = null, id) {
        const typePrefix = m.type === 'Sister' ? 'S.' : (m.type === 'Elder' ? 'E.' : '');
        const displayPrefix = m.type === 'Unknown' ? '' : typePrefix;

        return {
            id: id,
            name: `${displayPrefix} ${m.lastName}`.trim(),
            originalName: m.originalName,
            lastName: m.lastName, 
            firstName: m.firstName,
            area: m.area,
            district: m.district,
            zone: m.zone,
            address: m.address,
            phoneNumbers: m.phoneNumbers,
            selectedPhone: m.selectedPhone,
            position: m.position,
            type: m.type,
            verified: false
        };
    }

    function createCombinedContactRow(group, id) {
        const m1 = group[0];
        const typePrefix = m1.type === 'Sister' ? 'S.' : (m1.type === 'Elder' ? 'E.' : '');
        
        const joiner = currentLang === 'pt' ? ' e ' : ' & ';
        const names = group.map(m => m.lastName).join(joiner);
        
        let allPhones = [];
        group.forEach(m => allPhones = [...allPhones, ...m.phoneNumbers]);
        allPhones = [...new Set(allPhones)]; 
        
        // Combine full names with a newline for the table cell
        const combinedFullNames = group.map(m => m.originalName).join('\n');

        return {
            id: id,
            name: `${typePrefix} ${names}`,
            originalName: combinedFullNames,
            lastName: m1.lastName, 
            firstName: m1.firstName,
            area: m1.area,
            district: m1.district,
            zone: m1.zone,
            address: m1.address, 
            phoneNumbers: allPhones,
            selectedPhone: allPhones[0] || '', 
            position: group.map(m => m.position).filter(Boolean).join('/'),
            type: m1.type, 
            verified: false
        };
    }
    
    function render() {
        renderTableHead();
        renderTableBody();
        renderColumnToggles();
        lucide.createIcons();
    }
    
    function renderTableHead() {
        tableHead.innerHTML = '';
        const tr = document.createElement('tr');
        columnConfig.filter(c => c.visible).forEach(col => {
            const th = document.createElement('th');
            th.textContent = translations[currentLang][col.titleKey] || col.titleKey;
            th.dataset.key = col.key;
            tr.appendChild(th);
        });
        tableHead.appendChild(tr);
    }

    function renderTableBody() {
        tableBody.innerHTML = '';

        const groupedByZone = missionaryData.reduce((acc, item) => {
            const zone = item.zone || translations[currentLang].unassigned;
            if (!acc[zone]) acc[zone] = [];
            acc[zone].push(item);
            return acc;
        }, {});

        const sortedZones = Object.keys(groupedByZone).sort((a, b) => a.localeCompare(b));
        
        sortedZones.forEach(zone => {
            const headerRow = document.createElement('tr');
            headerRow.className = 'zone-header';
            const headerCell = document.createElement('th');
            headerCell.colSpan = columnConfig.filter(c => c.visible).length;
            headerCell.textContent = zone;
            tableBody.appendChild(headerRow); 
            
            groupedByZone[zone].sort((a,b) => a.name.localeCompare(b.name));

            groupedByZone[zone].forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id; 

                columnConfig.filter(c => c.visible).forEach(col => {
                    const td = document.createElement('td');
                    td.dataset.key = col.key;
                    if (col.editable) td.contentEditable = true;
                    
                    let content = item[col.key] || '';

                    switch (col.key) {
                        case 'verified': td.innerHTML = `<label class="checkbox" style="display: flex; justify-content: center;"><input type="checkbox" data-id="${item.id}" class="verified-checkbox" ${item.verified ? 'checked' : ''}></label>`; break;
                        case 'originalName': td.innerHTML = (item.originalName || '').replace(/\n/g, '<br>'); break;
                        case 'phone': td.innerHTML = createPhoneDropdownHTML(item); break;
                        case 'type': td.innerHTML = createTypeDropdownHTML(item); break;
                        case 'actions': td.innerHTML = createActionButtonsHTML(item); break;
                        default: td.textContent = content;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        });
    }

    function renderColumnToggles() {
        columnToggleContainer.innerHTML = '';
        columnConfig.forEach(col => {
            const item = document.createElement('div');
            item.className = 'dropdown-item sortable-item';
            item.dataset.key = col.key;
            
            const handle = document.createElement('span');
            handle.className = 'drag-handle icon is-small';
            handle.innerHTML = '<i data-lucide="grip-vertical"></i>';
            
            const label = document.createElement('label');
            label.className = 'checkbox ml-2';
            label.innerHTML = `<input type="checkbox" data-key="${col.key}" ${col.visible ? 'checked' : ''}> ${translations[currentLang][col.titleKey] || col.titleKey}`;
            
            item.appendChild(handle);
            item.appendChild(label);
            columnToggleContainer.appendChild(item);
        });

        columnToggleContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const col = columnConfig.find(c => c.key === e.target.dataset.key);
                col.visible = e.target.checked;
                saveToLocalStorage();
                render();
            });
        });

        new Sortable(columnToggleContainer, {
            animation: 150,
            handle: '.sortable-item', 
            onEnd: (evt) => {
                const newOrder = Array.from(columnToggleContainer.querySelectorAll('.sortable-item')).map(el => el.dataset.key);
                const newConfig = [];
                newOrder.forEach(key => {
                    const col = columnConfig.find(c => c.key === key);
                    if (col) newConfig.push(col);
                });
                columnConfig = newConfig;
                saveToLocalStorage();
                render();
            }
        });
    }
    
    function createPhoneDropdownHTML(item) {
        let inputHtml = '';
        if (item.phoneNumbers.length <= 1) {
            inputHtml = `<input type="text" class="input is-small phone-input" data-id="${item.id}" value="${item.selectedPhone}">`;
        } else {
            let options = item.phoneNumbers.map(n => `<option value="${n}" ${n === item.selectedPhone ? 'selected' : ''}>${n}</option>`).join('');
            options += `<option value="other">${translations[currentLang].other}</option>`;
            inputHtml = `<div class="select is-small is-fullwidth"><select class="phone-select" data-id="${item.id}">${options}</select></div>`;
        }
        return `<div class="field has-addons mb-0"><div class="control is-expanded">${inputHtml}</div><div class="control"><button class="button is-small copy-phone-btn" title="Copy without +258"><span class="icon is-small"><i data-lucide="copy"></i></span></button></div></div>`;
    }

    function createTypeDropdownHTML(item) {
        if (item.type !== 'Unknown') return translations[currentLang][item.type.toLowerCase()] || item.type;
        return `<div class="select is-small is-fullwidth is-danger"><select class="type-select" data-id="${item.id}"><option value="Unknown">-- ${translations[currentLang].select} --</option><option value="Elder">${translations[currentLang].elder}</option><option value="Sister">${translations[currentLang].sister}</option></select></div>`;
    }
    
    function createActionButtonsHTML(item) {
        const safePhone = (item.selectedPhone || '').replace(/\D/g, '');
        return `<div class="buttons is-flex is-flex-wrap-nowrap action-buttons"><button class="button is-small is-success whatsapp-btn" ${!safePhone ? 'disabled' : ''} title="Open WhatsApp"><span class="icon"><i data-lucide="message-circle"></i></span></button><button class="button is-small is-info edit-btn" title="Edit Row"><span class="icon"><i data-lucide="pencil"></i></span></button><button class="button is-small is-danger delete-btn" title="Delete Row"><span class="icon"><i data-lucide="trash-2"></i></span></button></div>`;
    }

    // --- Event Listeners for Table Interactions ---
    tableBody.addEventListener('change', e => {
        const target = e.target; const id = parseInt(target.dataset.id, 10); if (!id) return;
        const item = missionaryData.find(m => m.id === id); if(!item) return;
        
        if (target.classList.contains('verified-checkbox')) {
            item.verified = target.checked;
        } 
        else if (target.classList.contains('phone-select')) {
            if (target.value === 'other') {
                const newPhone = prompt(translations[currentLang].enterNewPhone);
                if (newPhone) {
                    const normalized = '+258' + newPhone.replace(/\D/g, '').slice(-9);
                    if (!item.phoneNumbers.includes(normalized)) item.phoneNumbers.push(normalized);
                    item.selectedPhone = normalized;
                }
                render(); 
            } else {
                item.selectedPhone = target.value;
            }
            showToast(translations[currentLang].phoneUpdated);
        }
        else if (target.classList.contains('type-select')) {
            item.type = target.value;
            
            // 1. Determine the new prefix
            const newPrefix = item.type === 'Sister' ? 'S.' : (item.type === 'Elder' ? 'E.' : '');
            
            // 2. Strip existing "S.", "E.", "S. ", "E. " from the start of the current name
            // This works for "Smith", "Smith & Jones", "E. Smith", etc.
            let rawName = item.name.replace(/^(S\.|E\.)\s*/, '').trim();

            // 3. Apply new prefix
            item.name = `${newPrefix} ${rawName}`.trim();
            
            // 4. Save and Render
            saveToLocalStorage();
            render(); 
        }
        else if (target.classList.contains('phone-input')) {
            item.selectedPhone = target.value;
            if(!item.phoneNumbers.includes(target.value)) item.phoneNumbers.push(target.value);
            showToast(translations[currentLang].phoneUpdated);
        }

        saveToLocalStorage();
    });

    tableBody.addEventListener('blur', e => {
        const target = e.target; if (!target.hasAttribute('contenteditable')) return;
        const row = target.closest('tr');
        const id = parseInt(row.dataset.id, 10); if (!id) return;
        const item = missionaryData.find(m => m.id === id); if(!item) return;
        
        const key = target.closest('td').dataset.key; const newValue = target.textContent.trim();
        if (item[key] !== newValue) {
            item[key] = newValue;
            saveToLocalStorage();
            if(key === 'name') showToast(translations[currentLang].contactUpdated);
        }
    }, true);

    tableBody.addEventListener('click', e => {
        const button = e.target.closest('button'); if(!button) return;
        const row = button.closest('tr');
        const id = parseInt(row.dataset.id, 10);

        const item = missionaryData.find(m => m.id === id);

        if (button.classList.contains('whatsapp-btn')) { 
            if (item) { 
                const phone = item.selectedPhone.replace(/\D/g, ''); 
                if (phone) window.open(`https://wa.me/${phone}`, '_blank', 'noopener'); 
            } 
        }
        else if (button.classList.contains('delete-btn')) { 
            if (confirm(translations[currentLang].confirmDelete)) { 
                missionaryData = missionaryData.filter(m => m.id !== id); 
                saveToLocalStorage(); 
                render(); 
            } 
        }
        else if (button.classList.contains('edit-btn')) {
            openMissionaryModal(id);
        }
        else if (button.classList.contains('copy-phone-btn')) {
            if(item && item.selectedPhone) {
                const phoneToCopy = item.selectedPhone.replace('+258', '').trim();
                navigator.clipboard.writeText(phoneToCopy).then(() => {
                    const icon = button.querySelector('i');
                    if(icon) {
                        icon.setAttribute('data-lucide', 'check');
                        lucide.createIcons();
                        setTimeout(() => {
                            icon.setAttribute('data-lucide', 'copy');
                            lucide.createIcons();
                        }, 1500);
                    }
                });
            }
        }
    });

    // --- Modals and Clear Logic ---
    addMissionaryBtn.addEventListener('click', () => openMissionaryModal());

    clearAllBtn.addEventListener('click', () => {
        clearModal.classList.add('is-active');
    });

    confirmClearBtn.addEventListener('click', () => {
        missionaryData = [];
        initialUploadData = [];
        saveToLocalStorage();
        render();
        clearModal.classList.remove('is-active');
    });

    const closeClearModal = () => clearModal.classList.remove('is-active');
    cancelClearBtn.addEventListener('click', closeClearModal);
    closeClearModalBtn.addEventListener('click', closeClearModal);

    function openMissionaryModal(id = null) {
        const titleEl = document.getElementById('missionary-modal-title');
        document.getElementById('missionary-form').reset();
        document.getElementById('missionary-id').value = id || '';
        if (id !== null) {
            const m = missionaryData.find(m => m.id === id); if (!m) return;
            titleEl.textContent = translations[currentLang].editMissionaryTitle;
            document.getElementById('modal-name').value = m.name || ''; 
            document.getElementById('modal-area').value = m.area || ''; 
            document.getElementById('modal-district').value = m.district || '';
            document.getElementById('modal-zone').value = m.zone || ''; 
            document.getElementById('modal-phone').value = m.selectedPhone || '';
            document.getElementById('modal-address').value = m.address || ''; 
            document.getElementById('modal-position').value = m.position || '';
            document.getElementById('modal-type').value = m.type || 'Unknown';
        } else { titleEl.textContent = translations[currentLang].addMissionaryTitle; }
        missionaryModal.classList.add('is-active');
    }

    saveMissionaryBtn.addEventListener('click', () => {
        const id = parseInt(document.getElementById('missionary-id').value, 10);
        const newData = { 
            id: id || Date.now(), 
            name: document.getElementById('modal-name').value, 
            area: document.getElementById('modal-area').value, 
            district: document.getElementById('modal-district').value, 
            zone: document.getElementById('modal-zone').value, 
            selectedPhone: document.getElementById('modal-phone').value, 
            address: document.getElementById('modal-address').value, 
            position: document.getElementById('modal-position').value,
            type: document.getElementById('modal-type').value
        };
        
        const phoneInput = newData.selectedPhone;
        const normalized = phoneInput.startsWith('+') ? phoneInput : ('+258' + phoneInput.replace(/\D/g, '').slice(-9));
        newData.selectedPhone = normalized;
        newData.phoneNumbers = [normalized]; 

        if (id) { 
            const index = missionaryData.findIndex(m => m.id === id); 
            if (index > -1) {
                const old = missionaryData[index];
                if(old.selectedPhone === newData.selectedPhone) newData.phoneNumbers = old.phoneNumbers;
                missionaryData[index] = { ...old, ...newData }; 
            }
        } else { 
            newData.verified = false;
            missionaryData.push(newData); 
        }
        saveToLocalStorage(); render(); missionaryModal.classList.remove('is-active');
    });

    const closeMissionaryModal = () => missionaryModal.classList.remove('is-active');
    cancelMissionaryModalBtn.addEventListener('click', closeMissionaryModal);
    missionaryModalCloseBtn.addEventListener('click', closeMissionaryModal);
    
    // --- EXPORT LOGIC ---
    function getExportContacts(data = missionaryData) {
        return data.map(m => {
            return {
                firstName: m.name, 
                middleName: '|',
                lastName: `${m.area} [${m.zone}]`,
                phone: m.selectedPhone
            };
        });
    }

    function generateCsv(data, filename) {
        const BOM = "\uFEFF"; 
        let csvContent = "";
        const headers = [`"${translations[currentLang].csvFirstName}"`, `"${translations[currentLang].csvMiddleName}"`, `"${translations[currentLang].csvLastName}"`, `"${translations[currentLang].csvPhoneNumber}"`].join(';');
        csvContent += headers + "\r\n";

        data.forEach(c => {
            let phoneStr = c.phone.startsWith('+') ? c.phone : `+${c.phone}`;
            if(c.phone && c.phone.trim() !== '') phoneStr = `\t${phoneStr}`; 
            const row = [`"${c.firstName}"`, `"${c.middleName}"`, `"${c.lastName}"`, `"${phoneStr}"`].join(';');
            csvContent += row + "\r\n";
        });

        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    exportCsvBtn.addEventListener('click', () => {
        const contacts = getExportContacts(missionaryData);
        generateCsv(contacts, "missionary_contacts.csv");
    });

    exportChangedBtn.addEventListener('click', () => {
        if (initialUploadData.length === 0) { alert('Please upload a file first.'); return; }
        const initialAreaPhones = {};
        initialUploadData.forEach(m => initialAreaPhones[m.area] = m.selectedPhone);

        const changedRows = missionaryData.filter(m => {
            return m.area && initialAreaPhones[m.area] !== m.selectedPhone;
        });

        if (changedRows.length === 0) { alert(translations[currentLang].noChangesFound); return; }
        generateCsv(getExportContacts(changedRows), 'changed_missionary_numbers.csv');
    });

    exportVcardBtn.addEventListener('click', () => {
        const contacts = getExportContacts();
        let vcardContent = "";
        contacts.forEach(c => {
            vcardContent += "BEGIN:VCARD\r\nVERSION:3.0\r\n";
            vcardContent += `N:;${c.firstName};;;\r\nFN:${c.firstName}\r\n`; 
            if (c.phone) vcardContent += `TEL;TYPE=CELL:${c.phone}\r\n`;
            vcardContent += "END:VCARD\r\n";
        });
        const blob = new Blob([vcardContent], { type: 'text/vcard;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.setAttribute('download', 'missionary_contacts.vcf');
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    });

    backupBtn.addEventListener('click', () => {
        if(missionaryData.length === 0) { alert(translations[currentLang].noDataBackup); return; }
        const dataToSave = { missionaryData: missionaryData, initialUploadData: initialUploadData };
        const jsonData = JSON.stringify(dataToSave, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.download = `missionary_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    });
    
    restoreBackupInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const restored = JSON.parse(event.target.result);
                if (Array.isArray(restored.missionaryData)) {
                    missionaryData = restored.missionaryData;
                    initialUploadData = restored.initialUploadData || [];
                    saveToLocalStorage();
                    mainContent.style.display = 'block';
                    render();
                    alert(translations[currentLang].dataRestored);
                } else alert(translations[currentLang].invalidBackup);
            } catch (error) { alert(translations[currentLang].parseError); console.error('Restore error:', error); }
        };
        reader.readAsText(file); e.target.value = ''; 
    });

    loadFromLocalStorage();
});
</script>

</body>
</html>