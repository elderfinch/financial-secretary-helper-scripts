<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missionary Roster Randomizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 2em; }
        #downloadLink { display: none; margin-top: 1em; }
    </style>
</head>
<body>
    <h1>Missionary Roster Randomizer</h1>
    <p>Upload a CSV file to randomize the 'Area' for 22-27% of the missionaries.</p>
    <input type="file" id="csvFileInput" accept=".csv">
    <button onclick="randomize()">Randomize Areas</button>
    <a id="downloadLink" download="randomized_roster.csv">Download Randomized CSV</a>

    <script>
        let data = [];

        document.getElementById('csvFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    complete: (results) => {
                        data = results.data;
                    }
                });
            }
        });

        function randomize() {
            if (data.length === 0) {
                alert("Please upload a CSV file first.");
                return;
            }

            const uniqueAreas = [...new Set(data.map(row => row.Area).filter(area => area))];
            const missionariesToRandomizeCount = Math.floor(data.length * (Math.random() * (0.27 - 0.22) + 0.22));

            let randomizedData = JSON.parse(JSON.stringify(data)); // Deep copy
            let randomizedIndices = new Set();

            while (randomizedIndices.size < missionariesToRandomizeCount) {
                const randomIndex = Math.floor(Math.random() * randomizedData.length);
                if (!randomizedIndices.has(randomIndex)) {
                    randomizedIndices.add(randomIndex);
                    const newArea = uniqueAreas[Math.floor(Math.random() * uniqueAreas.length)];
                    randomizedData[randomIndex].Area = newArea;
                }
            }

            const csv = Papa.unparse(randomizedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = url;
            downloadLink.style.display = 'block';
        }
    </script>
</body>
</html>